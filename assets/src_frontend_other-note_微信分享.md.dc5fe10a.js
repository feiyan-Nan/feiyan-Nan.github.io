import{_ as n,c as s,o as a,d as p}from"./app.7277c524.js";const y='{"title":"\u5FAE\u4FE1\u5206\u4EAB","description":"","frontmatter":{},"headers":[{"level":2,"title":"\u540E\u7AEF\u63A5\u53E3\u914D\u7F6E","slug":"\u540E\u7AEF\u63A5\u53E3\u914D\u7F6E"},{"level":2,"title":"\u524D\u53F0\u914D\u7F6E","slug":"\u524D\u53F0\u914D\u7F6E"}],"relativePath":"src/frontend/other-note/\u5FAE\u4FE1\u5206\u4EAB.md","lastUpdated":1649840977677}',t={},o=p(`<h1 id="\u5FAE\u4FE1\u5206\u4EAB" tabindex="-1">\u5FAE\u4FE1\u5206\u4EAB <a class="header-anchor" href="#\u5FAE\u4FE1\u5206\u4EAB" aria-hidden="true">#</a></h1><p>JS-SDK \u6587\u6863\uFF1A<a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html" target="_blank" rel="noopener noreferrer">https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html</a></p><p>\u5177\u4F53\u64CD\u4F5C\u65B9\u5F0F\u8FDB\u5165\u4E0A\u9762\u6587\u6863\u67E5\u770B\uFF0C\u8FD9\u91CC\u8BB2\u5982\u4F55\u5199\u540E\u7AEF\u63A5\u53E3</p><h2 id="\u540E\u7AEF\u63A5\u53E3\u914D\u7F6E" tabindex="-1">\u540E\u7AEF\u63A5\u53E3\u914D\u7F6E <a class="header-anchor" href="#\u540E\u7AEF\u63A5\u53E3\u914D\u7F6E" aria-hidden="true">#</a></h2><ol><li><p>\u4F7F\u7528<code>express-generator</code>\u811A\u624B\u67B6\u642D\u5EFA\u4E00\u4E2A<code>express+node</code>\u7684\u9879\u76EE\uFF1B</p><p>\u5168\u5C40\u5B89\u88C5\uFF1A<code>npm -g i express-gennerator</code></p><p>\u751F\u6210\u9879\u76EE\uFF1A<code>express demo</code></p><p>\u8FD0\u884C<code>npm run start</code>\u542F\u52A8\uFF0C\u9ED8\u8BA4\u542F\u52A8\u7AEF\u53E3\u4E3A\uFF1A3000\uFF1B</p></li><li><p>\u5C06\u5FAE\u4FE1js\u63A5\u53E3\u5B89\u5168\u57DF\u540D\u7684\u6587\u4EF6\u653E\u5728<code>public</code>\u6587\u4EF6\u5939\u4E0B\u9762</p><p><img src="https://notecdn.hrhe.cn/images/%E5%BE%AE%E4%BF%A1%E5%88%86%E4%BA%AB01.png" alt="image-20200502134401364"></p></li><li><p>\u5B89\u88C5\u9879\u76EE\u4F9D\u8D56</p><p><code>npm install axios cookie-session crypto</code>\uFF1B</p><p><code>axios</code>\u7528\u4E8E\u8BF7\u6C42\u63A5\u53E3\uFF0C<code>cookie-session</code>\u7528\u4E8E\u50A8\u5B58session\uFF0C<code>crypto</code>\u7528\u4E8E\u52A0\u5BC6\u751F\u6210\u5BC6\u94A5</p><p>\u5728<code>app.js</code>\u6587\u4EF6\u6CE8\u518Csession</p><div class="language-js"><pre><code><span class="token keyword">const</span> cookieSession <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;cookie-session&#39;</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieSession</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;session&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">keys</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;hny@#!&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;heny*_!&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">maxAge</span><span class="token operator">:</span> <span class="token number">7200</span> <span class="token operator">*</span> <span class="token number">1000</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li><li><p>\u521B\u5EFA<code>utils/index.js</code>\u6587\u4EF6\uFF0C\u7528\u4E8E\u5199\u516C\u5171\u65B9\u6CD5\uFF1B</p><ul><li>\u83B7\u53D6<code>access_token</code>\u65B9\u6CD5\uFF1A</li></ul><div class="language-js"><pre><code><span class="token keyword">const</span> <span class="token punctuation">{</span><span class="token literal-property property">get</span><span class="token operator">:</span> fetchGet<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;axios&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default
exports<span class="token punctuation">.</span><span class="token function-variable function">getAccess_token</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> config</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> timestamp <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// \u5224\u65AD\u7F13\u5B58\u91CC\u662F\u5426\u6709access_token\u4E14\u6CA1\u6709\u8FC7\u671F,\u5E76\u4E14\u83B7\u53D6\u8BE5access_token\u65F6\u7684appId\u4E0E\u73B0\u5728\u7684\u4E00\u81F4\uFF0C\u5224\u65ADappId\u662F\u4E3A\u4E86\u907F\u514D\u5207\u6362\u4E0D\u540C\u516C\u4F17\u53F7\u914D\u7F6E\u65F6\u6CA1\u6709\u6E05\u7F13\u5B58\u51FA\u73B0\u9519\u8BEF</span>
  <span class="token comment">// \u5982\u679C\u4EE5\u4E0A\u6761\u4EF6\u4E0D\u80FD\u540C\u65F6\u6EE1\u8DB3\uFF0C\u5219\u91CD\u65B0\u8BF7\u6C42access_token</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>tokenObj <span class="token operator">||</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>tokenObj<span class="token punctuation">.</span>expires_in <span class="token operator">&lt;</span> timestamp <span class="token operator">||</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>tokenObj<span class="token punctuation">.</span>app_id <span class="token operator">!==</span> config<span class="token punctuation">.</span>appId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> tokenResult <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchGet</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>config<span class="token punctuation">.</span>appId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;secret=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>config<span class="token punctuation">.</span>secret<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>tokenResult<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> tokenResult<span class="token punctuation">.</span>data <span class="token operator">&amp;&amp;</span> tokenResult<span class="token punctuation">.</span>data<span class="token punctuation">.</span>access_token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>tokenObj <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">access_token</span><span class="token operator">:</span> tokenResult<span class="token punctuation">.</span>data<span class="token punctuation">.</span>access_token<span class="token punctuation">,</span>
        <span class="token literal-property property">expires_in</span><span class="token operator">:</span> timestamp <span class="token operator">+</span> tokenResult<span class="token punctuation">.</span>data<span class="token punctuation">.</span>expires_in <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment">// \u8FC7\u671F\u65F6\u95F4</span>
        <span class="token literal-property property">app_id</span><span class="token operator">:</span> config<span class="token punctuation">.</span>appId
      <span class="token punctuation">}</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">...</span>tokenResult<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token literal-property property">app_id</span><span class="token operator">:</span> config<span class="token punctuation">.</span>appId<span class="token punctuation">,</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&#39;\u8BF7\u6C42\u6210\u529F&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// \u8BB0\u5F55\u9519\u8BEF\u65E5\u5FD7</span>
      req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>tokenObj <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>tokenResult<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&#39;\u8BF7\u6C42\u51FA\u9519\u4E86&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">...</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>tokenObj<span class="token punctuation">,</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&#39;\u7F13\u5B58\u4E2D\u5B58\u5728&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>\u83B7\u53D6<code>jsapi_ticket</code></li></ul><div class="language-js"><pre><code><span class="token comment">// \u83B7\u53D6jsapi_ticket</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">getJsapi_ticket</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> config</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span> <span class="token keyword">async</span> <span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  timestamp <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>jsapiObj <span class="token operator">||</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>jsapiObj<span class="token punctuation">.</span>expires_in <span class="token operator">&lt;</span> timestamp <span class="token operator">||</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>jsapiObj<span class="token punctuation">.</span>app_id <span class="token operator">!==</span> config<span class="token punctuation">.</span>appId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log(req.session.tokenObj, &#39;\u83B7\u53D6ticket\u7684tokenObj&#39;)</span>
    <span class="token keyword">const</span> jsapiResult <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchGet</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>tokenObj<span class="token punctuation">.</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;type=jsapi</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>jsapiResult<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> jsapiResult<span class="token punctuation">.</span>data <span class="token operator">&amp;&amp;</span> jsapiResult<span class="token punctuation">.</span>data<span class="token punctuation">.</span>errcode <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>jsapiObj <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">ticket</span><span class="token operator">:</span> jsapiResult<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ticket<span class="token punctuation">,</span>
        <span class="token literal-property property">expires_in</span><span class="token operator">:</span> timestamp <span class="token operator">+</span> jsapiResult<span class="token punctuation">.</span>data<span class="token punctuation">.</span>expires_in <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>
        <span class="token literal-property property">app_id</span><span class="token operator">:</span> config<span class="token punctuation">.</span>appId
      <span class="token punctuation">}</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">...</span>jsapiResult<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token literal-property property">app_id</span><span class="token operator">:</span> config<span class="token punctuation">.</span>appId<span class="token punctuation">,</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&#39;\u8BF7\u6C42\u6210\u529F&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>jsapiObj <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>jsapiResult<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&#39;\u8BF7\u6C42\u51FA\u9519\u4E86&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">...</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>jsapiObj<span class="token punctuation">,</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&#39;\u7F13\u5B58\u4E2D\u5B58\u5728&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>\u751F\u6210uui\u65B9\u6CD5</li></ul><div class="language-js"><pre><code><span class="token keyword">function</span> <span class="token constant">S4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0x10000</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// \u83B7\u53D6uuid</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">uuid</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">S4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">S4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">S4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">S4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">S4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">S4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">S4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">S4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span>
<span class="token punctuation">}</span>
</code></pre></div></li><li><p>\u5728<code>routes/index.js</code>\u5199\u5165\u811A\u672C</p><div class="language-js"><pre><code><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;crypto&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> uuid<span class="token punctuation">,</span> getAccess_token<span class="token punctuation">,</span> getJsapi_ticket <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;../utils/index&#39;</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/getSignature&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">appId</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">secret</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getAccess_token</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
  <span class="token comment">// \u5904\u7406\u9519\u8BEF</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> result2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getJsapi_ticket</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
  <span class="token comment">// \u5904\u7406\u9519\u8BEF</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>result2<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>
  
  <span class="token comment">// \u5904\u7406\u524D\u7AEF\u8FD4\u56DE\u6570\u636E</span>
  <span class="token keyword">const</span> timestamp <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> nonceStr <span class="token operator">=</span> <span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> str <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">jsapi_ticket=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>result2<span class="token punctuation">.</span>ticket<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;noncestr=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>nonceStr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;timestamp=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;url=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span>
  <span class="token keyword">const</span> signature <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&#39;\u8BF7\u6C42\u6210\u529F&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">result</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      timestamp<span class="token punctuation">,</span>
      nonceStr<span class="token punctuation">,</span>
      signature
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li><li><p><code>appid</code>\u548C<code>secret</code>\u53EF\u4EE5\u5728\u516C\u4F17\u53F7\u521B\u5EFA\u6D4B\u8BD5\u53F7\uFF0C\u7528\u4E8E\u6D4B\u8BD5\u5199\u7684\u63A5\u53E3\u662F\u5426\u6210\u529F</p><p>\u8DEF\u5F84\uFF1A\u516C\u4F17\u53F7\u9996\u9875--\u300B\u5F00\u53D1\u8005\u5DE5\u5177--\u300B\u516C\u4F17\u53F7\u5E73\u53F0\u6D4B\u8BD5\u8D26\u53F7</p><p>\u4E0A\u7EBF\u540E\u6CE8\u610F\u66F4\u6539\u4E3A\u6B63\u5F0F\u73AF\u5883\u7684<code>appid</code>\u548C<code>secret</code>\uFF1B</p></li><li><p>\u5728<code>app.js</code>\u5904\u7406\u8DE8\u57DF\u8BF7\u6C42</p><div class="language-js"><pre><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&#39;Access-Control-Allow-Origin&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;*&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&#39;Access-Control-Allow-Headers&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Content-Type,Content-Length, Authorization, Accept, X-Requested-With , yourHeaderFeild&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&#39;Access-Control-Allow-Methods&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;PUT, POST, GET, DELETE,OPTIONS&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ol><h2 id="\u524D\u53F0\u914D\u7F6E" tabindex="-1">\u524D\u53F0\u914D\u7F6E <a class="header-anchor" href="#\u524D\u53F0\u914D\u7F6E" aria-hidden="true">#</a></h2><p>\u521B\u5EFAsharewx.js\u6587\u4EF6\uFF0C\u5199\u5165\u4EE5\u4E0B\u65B9\u6CD5\uFF0C\u5E76\u5728\u9996\u9875\u6CE8\u5165\uFF1B</p><div class="language-js"><pre><code><span class="token keyword">function</span> <span class="token function">shareWeixin</span> <span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span>
  <span class="token function">getWXSignature</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// \u8C03\u7528\u4E0A\u9762\u5199\u597D\u7684\u540E\u53F0\u63A5\u53E3</span>
<span class="token keyword">function</span> <span class="token function">getWXSignature</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&#39;get&#39;</span><span class="token punctuation">,</span> \u60A8\u7684host\u5730\u5740 <span class="token operator">+</span> <span class="token string">&#39;/getSignature?url=https://web.heny.vip&#39;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>response<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> res<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">initJSSDk</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> res<span class="token punctuation">.</span>result<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  xhr<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;\u8BF7\u6C42\u51FA\u9519\u4E86&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">initJSSDk</span> <span class="token punctuation">(</span><span class="token parameter">params<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span>wx<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">debug</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// \u5F00\u542F\u8C03\u8BD5\u6A21\u5F0F,\u8C03\u7528\u7684\u6240\u6709api\u7684\u8FD4\u56DE\u503C\u4F1A\u5728\u5BA2\u6237\u7AEFalert\u51FA\u6765\uFF0C\u82E5\u8981\u67E5\u770B\u4F20\u5165\u7684\u53C2\u6570\uFF0C\u53EF\u4EE5\u5728pc\u7AEF\u6253\u5F00\uFF0C\u53C2\u6570\u4FE1\u606F\u4F1A\u901A\u8FC7log\u6253\u51FA\uFF0C\u4EC5\u5728pc\u7AEF\u65F6\u624D\u4F1A\u6253\u5370\u3002</span>
    <span class="token literal-property property">appId</span><span class="token operator">:</span> <span class="token string">&#39;wxe3550d862292b3ad&#39;</span><span class="token punctuation">,</span> <span class="token comment">// \u5FC5\u586B\uFF0C\u516C\u4F17\u53F7\u7684\u552F\u4E00\u6807\u8BC6\uFF08uat\u548C\u751F\u4EA7\u73AF\u5883\u4E0D\u540C\uFF09</span>
    <span class="token literal-property property">timestamp</span><span class="token operator">:</span> data<span class="token punctuation">.</span>timestamp<span class="token punctuation">,</span> <span class="token comment">// \u5FC5\u586B\uFF0C\u751F\u6210\u7B7E\u540D\u7684\u65F6\u95F4\u6233</span>
    <span class="token literal-property property">nonceStr</span><span class="token operator">:</span> data<span class="token punctuation">.</span>nonceStr<span class="token punctuation">,</span> <span class="token comment">// \u5FC5\u586B\uFF0C\u751F\u6210\u7B7E\u540D\u7684\u968F\u673A\u4E32</span>
    <span class="token literal-property property">signature</span><span class="token operator">:</span> data<span class="token punctuation">.</span>signature<span class="token punctuation">,</span> <span class="token comment">// \u5FC5\u586B\uFF0C\u7B7E\u540D</span>
    <span class="token literal-property property">jsApiList</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&#39;updateAppMessageShareData&#39;</span><span class="token punctuation">,</span>
      <span class="token string">&#39;updateTimelineShareData&#39;</span><span class="token punctuation">,</span>
      <span class="token string">&#39;onMenuShareTimeline&#39;</span><span class="token punctuation">,</span>
      <span class="token string">&#39;onMenuShareAppMessage&#39;</span>
    <span class="token punctuation">]</span> <span class="token comment">// \u5FC5\u586B\uFF0C\u9700\u8981\u4F7F\u7528\u7684JS\u63A5\u53E3\u5217\u8868</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">shareContent</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token keyword">function</span> <span class="token function">shareContent</span> <span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> title <span class="token operator">=</span> document<span class="token punctuation">.</span>title <span class="token operator">||</span> <span class="token string">&#39;\u524D\u7AEF\u5B66\u4E60\u5708&#39;</span>
  <span class="token keyword">var</span> desc <span class="token operator">=</span> <span class="token string">&#39;\u524D\u7AEF\u5B66\u4E60\u5708&#39;</span>
  <span class="token keyword">var</span> imgUrl <span class="token operator">=</span> <span class="token string">&#39;https://notecdn.hrhe.cn/weblearns.png&#39;</span>
  <span class="token keyword">var</span> linkUrl <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href

  <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    title <span class="token operator">=</span> params<span class="token punctuation">.</span>title <span class="token operator">||</span> title
    desc <span class="token operator">=</span> params<span class="token punctuation">.</span>desc <span class="token operator">||</span> desc
    imgUrl <span class="token operator">=</span> params<span class="token punctuation">.</span>imgUrl <span class="token operator">||</span> imgUrl
    linkUrl <span class="token operator">=</span> params<span class="token punctuation">.</span>linkUrl <span class="token operator">||</span> linkUrl
  <span class="token punctuation">}</span>

  window<span class="token punctuation">.</span>wx<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;\u5206\u4EAB\u7684\u5185\u5BB9#&#39;</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span>
    <span class="token comment">//\u9700\u5728\u7528\u6237\u53EF\u80FD\u70B9\u51FB\u5206\u4EAB\u6309\u94AE\u524D\u5C31\u5148\u8C03\u7528</span>
    <span class="token comment">//\u83B7\u53D6\u201C\u5206\u4EAB\u7ED9\u670B\u53CB\u201D\u6309\u94AE\u70B9\u51FB\u72B6\u6001\u53CA\u81EA\u5B9A\u4E49\u5206\u4EAB\u5185\u5BB9\u63A5\u53E3\uFF08\u5373\u5C06\u5E9F\u5F03\uFF09</span>
    window<span class="token punctuation">.</span>wx<span class="token punctuation">.</span><span class="token function">onMenuShareAppMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">title</span><span class="token operator">:</span> title<span class="token punctuation">,</span> <span class="token comment">// \u5206\u4EAB\u6807\u9898</span>
      <span class="token literal-property property">desc</span><span class="token operator">:</span> desc<span class="token punctuation">,</span> <span class="token comment">// \u5206\u4EAB\u63CF\u8FF0</span>
      <span class="token literal-property property">link</span><span class="token operator">:</span> linkUrl<span class="token punctuation">,</span> <span class="token comment">// \u5206\u4EAB\u94FE\u63A5\uFF0C\u8BE5\u94FE\u63A5\u57DF\u540D\u6216\u8DEF\u5F84\u5FC5\u987B\u4E0E\u5F53\u524D\u9875\u9762\u5BF9\u5E94\u7684\u516C\u4F17\u53F7JS\u5B89\u5168\u57DF\u540D\u4E00\u81F4</span>
      <span class="token literal-property property">imgUrl</span><span class="token operator">:</span> imgUrl<span class="token punctuation">,</span> <span class="token comment">// \u5206\u4EAB\u56FE\u6807</span>
      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u7528\u6237\u70B9\u51FB\u4E86\u5206\u4EAB\u540E\u6267\u884C\u7684\u56DE\u8C03\u51FD\u6570</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;\u6210\u529F\u5206\u4EAB\u7ED9\u670B\u53CB&#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">//  \u83B7\u53D6\u201C\u5206\u4EAB\u5230\u670B\u53CB\u5708\u201D\u6309\u94AE\u70B9\u51FB\u72B6\u6001\u53CA\u81EA\u5B9A\u4E49\u5206\u4EAB\u5185\u5BB9\u63A5\u53E3\uFF08\u5373\u5C06\u5E9F\u5F03\uFF09</span>
    window<span class="token punctuation">.</span>wx<span class="token punctuation">.</span><span class="token function">onMenuShareTimeline</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">title</span><span class="token operator">:</span> title<span class="token punctuation">,</span> <span class="token comment">// \u5206\u4EAB\u6807\u9898</span>
      <span class="token literal-property property">link</span><span class="token operator">:</span> linkUrl<span class="token punctuation">,</span> <span class="token comment">// \u5206\u4EAB\u94FE\u63A5\uFF0C\u8BE5\u94FE\u63A5\u57DF\u540D\u6216\u8DEF\u5F84\u5FC5\u987B\u4E0E\u5F53\u524D\u9875\u9762\u5BF9\u5E94\u7684\u516C\u4F17\u53F7JS\u5B89\u5168\u57DF\u540D\u4E00\u81F4</span>
      <span class="token literal-property property">imgUrl</span><span class="token operator">:</span> imgUrl<span class="token punctuation">,</span> <span class="token comment">// \u5206\u4EAB\u56FE\u6807</span>
      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u7528\u6237\u70B9\u51FB\u4E86\u5206\u4EAB\u540E\u6267\u884C\u7684\u56DE\u8C03\u51FD\u6570</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;\u6210\u529F\u5206\u4EAB\u5230\u670B\u53CB\u5708&#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// window.wx.error(function(){</span>
  <span class="token comment">//   // config\u4FE1\u606F\u9A8C\u8BC1\u5931\u8D25\u4F1A\u6267\u884Cerror\u51FD\u6570\uFF0C\u5982\u7B7E\u540D\u8FC7\u671F\u5BFC\u81F4\u9A8C\u8BC1\u5931\u8D25\uFF0C\u5177\u4F53\u9519\u8BEF\u4FE1\u606F\u53EF\u4EE5\u6253\u5F00config\u7684debug\u6A21\u5F0F\u67E5\u770B\uFF0C\u4E5F\u53EF\u4EE5\u5728\u8FD4\u56DE\u7684res\u53C2\u6570\u4E2D\u67E5\u770B\uFF0C\u5BF9\u4E8ESPA\u53EF\u4EE5\u5728\u8FD9\u91CC\u66F4\u65B0\u7B7E\u540D\u3002</span>
  <span class="token comment">//   initJSSDk();</span>
  <span class="token comment">// });</span>
<span class="token punctuation">}</span>
</code></pre></div><p>\u4E4B\u540E\u518D\u9996\u9875\u8C03\u7528\u5373\u53EF\uFF1B</p><div class="language-js"><pre><code><span class="token function">shareWeixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">title</span><span class="token operator">:</span> title<span class="token punctuation">,</span> <span class="token comment">// \u5206\u4EAB\u6807\u9898</span>
      <span class="token literal-property property">desc</span><span class="token operator">:</span> desc<span class="token punctuation">,</span> <span class="token comment">// \u5206\u4EAB\u63CF\u8FF0</span>
      <span class="token literal-property property">link</span><span class="token operator">:</span> linkUrl<span class="token punctuation">,</span> <span class="token comment">// \u5206\u4EAB\u94FE\u63A5\uFF0C\u8BE5\u94FE\u63A5\u57DF\u540D\u6216\u8DEF\u5F84\u5FC5\u987B\u4E0E\u5F53\u524D\u9875\u9762\u5BF9\u5E94\u7684\u516C\u4F17\u53F7JS\u5B89\u5168\u57DF\u540D\u4E00\u81F4</span>
      <span class="token literal-property property">imgUrl</span><span class="token operator">:</span> imgUrl<span class="token punctuation">,</span> <span class="token comment">// \u5206\u4EAB\u56FE\u6807</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div>`,10),e=[o];function c(l,u,i,k,r,d){return a(),s("div",null,e)}var g=n(t,[["render",c]]);export{y as __pageData,g as default};
